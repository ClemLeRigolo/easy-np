stages:
  - linter
  - test
  - badges



eslint:
  stage: linter
  tags:
    - docker
  image: lxsnsn/gitlab-ci-easynp
  script:
    - yarn install --cache-folder .yarn
    - npx eslint 'src/**/*.{js,jsx,ts,tsx}' > eslint_report.txt || echo $? > pass.txt
  cache:
    paths:
      - node_modules/
      - .yarn/
  artifacts:
    when: always
    paths:
      - eslint_report.txt
      - pass.txt

testing:
  stage: test
  tags:
    - docker
  image: lxsnsn/gitlab-ci-easynp
  script:
    - yarn install --cache-folder .yarn
    - export NODE_OPTIONS=--openssl-legacy-provider
    - npm run startLocal &
    - sleep 15
    - npx firebase emulators:start --import bdd --token $FIREBASE_LOGIN &
    - sleep 45        # wait for firebase to init emulators
    - npx cypress run > cypress_report.txt || echo $?
    - npx nyc report > coverage_report.txt || echo $?
  cache:
    paths:
      - node_modules/
      - .yarn/
  artifacts:
    when: always
    paths:
      - coverage_report.txt
      - cypress_report.txt

badges:
  stage: badges
  tags:
    - docker
  image: python
  script:
    - pip install anybadge
    - bash generateBadges.sh
  dependencies:
    - testing
    - eslint
  artifacts:
    when: always
    paths:
      - "lint.svg"
      - "cypress.svg"
      - "coverage.svg"
  when: always

